# Oracle + Seata AT模式 环境管理脚本

本目录包含完整的Oracle数据库 + Seata分布式事务环境的初始化和管理脚本。

## 📁 脚本文件说明

### 1. `oracle-seata-complete-init.sql` - **完整初始化脚本**
**用途**: 一键初始化完整的Oracle + Seata AT模式环境
**包含内容**:
- 🗑️ 清理现有对象（表、序列、触发器）
- 📊 创建业务表（orders订单表、stock库存表）
- 🔄 创建Seata系统表（global_table、branch_table、lock_table、undo_log）
- 🔢 创建所有必要的序列
- ⚡ 创建自动ID生成触发器
- 💾 插入初始库存数据
- ✅ 验证安装结果

**使用方法**:
```bash
sqlplus test/123456@localhost:1521/ORCL @oracle-seata-complete-init.sql
```

### 2. `oracle-seata-cleanup.sql` - **环境清理脚本**
**用途**: 清理Seata事务数据，重置测试环境
**清理内容**:
- 🧹 清理未完成的全局事务和分支事务
- 🔐 清理所有资源锁定
- 📝 清理所有回滚日志
- 📈 显示清理前后的数据统计
- 💡 可选清理业务数据

**使用方法**:
```bash
sqlplus test/123456@localhost:1521/ORCL @oracle-seata-cleanup.sql
```

## 🚀 快速开始

### 步骤1: 初始化环境
```bash
# 执行完整初始化
sqlplus test/123456@localhost:1521/ORCL @oracle-seata-complete-init.sql
```

### 步骤2: 启动Seata服务器
```bash
# 使用优化的启动脚本
cd C:\Users\quan\Desktop\seata\seata\bin
seata-server-optimized.bat
```

### 步骤3: 启动应用服务
```bash
# 启动订单服务（端口8080）
cd seata-demo/order-service
mvn spring-boot:run -Dspring-boot.run.profiles=local-oracle

# 启动库存服务（端口8081）  
cd seata-demo/stock-service
mvn spring-boot:run -Dspring-boot.run.profiles=local-oracle
```

### 步骤4: 测试分布式事务
```bash
# 测试成功场景
curl -X POST "http://localhost:8080/api/order/create?userId=user123&productId=1&quantity=2"

# 测试失败回滚场景（库存不足）
curl -X POST "http://localhost:8080/api/order/create?userId=user456&productId=1&quantity=2000"
```

## 📋 数据库表结构

### 业务表
- **orders**: 订单表 - 存储用户订单信息
- **stock**: 库存表 - 存储商品库存信息

### Seata系统表
- **global_table**: 全局事务表 - 记录分布式事务的全局信息
- **branch_table**: 分支事务表 - 记录分布式事务的分支信息  
- **lock_table**: 锁表 - 管理分布式事务的资源锁定
- **undo_log**: 回滚日志表 - AT模式回滚时使用的数据快照

## 🔧 故障排除

### 1. 如果遇到序列不存在错误
```bash
# 重新执行初始化脚本
sqlplus test/123456@localhost:1521/ORCL @oracle-seata-complete-init.sql
```

### 2. 如果事务一直卡住
```bash
# 执行清理脚本
sqlplus test/123456@localhost:1521/ORCL @oracle-seata-cleanup.sql
```

### 3. 如果Seata服务器启动失败
```bash
# 使用优化的启动脚本，内存设置已优化
seata-server-optimized.bat
```

## 📊 监控和观察

### 查看事务状态
```sql
-- 查看全局事务
SELECT xid, status, application_id, transaction_name, gmt_create FROM global_table;

-- 查看分支事务
SELECT xid, branch_id, resource_id, status FROM branch_table;

-- 查看资源锁
SELECT xid, table_name, pk FROM lock_table;

-- 查看回滚日志
SELECT xid, branch_id, log_status, log_created FROM undo_log;
```

### 查看业务数据
```sql
-- 查看订单
SELECT id, user_id, product_id, quantity, status, create_time FROM orders;

-- 查看库存
SELECT product_id, quantity, update_time FROM stock;
```

## ✨ 学习要点

1. **AT模式原理**: Seata会自动记录SQL执行前后的数据快照到undo_log表
2. **两阶段提交**: 
   - 第一阶段：业务SQL执行 + 记录undo_log
   - 第二阶段：根据全局事务结果决定提交或回滚
3. **资源锁定**: lock_table记录资源锁，防止脏写
4. **自动回滚**: 失败时根据undo_log中的快照自动生成反向SQL

## 🎯 测试建议

1. **正常流程测试**: 库存充足的情况下创建订单
2. **回滚测试**: 库存不足时观察自动回滚
3. **并发测试**: 多个请求同时操作相同商品
4. **异常测试**: 手动停止某个服务观察事务处理

---

**提示**: 这套脚本已经解决了Oracle + Seata集成的常见问题，包括序列命名、字段映射、主键约束等，可以直接用于学习和开发环境。