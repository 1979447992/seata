# Oracle + Seata ATæ¨¡å¼ ç¯å¢ƒç®¡ç†è„šæœ¬

æœ¬ç›®å½•åŒ…å«å®Œæ•´çš„Oracleæ•°æ®åº“ + Seataåˆ†å¸ƒå¼äº‹åŠ¡ç¯å¢ƒçš„åˆå§‹åŒ–å’Œç®¡ç†è„šæœ¬ã€‚

## ğŸ“ è„šæœ¬æ–‡ä»¶è¯´æ˜

### 1. `oracle-seata-complete-init.sql` - **å®Œæ•´åˆå§‹åŒ–è„šæœ¬**
**ç”¨é€”**: ä¸€é”®åˆå§‹åŒ–å®Œæ•´çš„Oracle + Seata ATæ¨¡å¼ç¯å¢ƒ
**åŒ…å«å†…å®¹**:
- ğŸ—‘ï¸ æ¸…ç†ç°æœ‰å¯¹è±¡ï¼ˆè¡¨ã€åºåˆ—ã€è§¦å‘å™¨ï¼‰
- ğŸ“Š åˆ›å»ºä¸šåŠ¡è¡¨ï¼ˆordersè®¢å•è¡¨ã€stockåº“å­˜è¡¨ï¼‰
- ğŸ”„ åˆ›å»ºSeataç³»ç»Ÿè¡¨ï¼ˆglobal_tableã€branch_tableã€lock_tableã€undo_logï¼‰
- ğŸ”¢ åˆ›å»ºæ‰€æœ‰å¿…è¦çš„åºåˆ—
- âš¡ åˆ›å»ºè‡ªåŠ¨IDç”Ÿæˆè§¦å‘å™¨
- ğŸ’¾ æ’å…¥åˆå§‹åº“å­˜æ•°æ®
- âœ… éªŒè¯å®‰è£…ç»“æœ

**ä½¿ç”¨æ–¹æ³•**:
```bash
sqlplus test/123456@localhost:1521/ORCL @oracle-seata-complete-init.sql
```

### 2. `oracle-seata-cleanup.sql` - **ç¯å¢ƒæ¸…ç†è„šæœ¬**
**ç”¨é€”**: æ¸…ç†Seataäº‹åŠ¡æ•°æ®ï¼Œé‡ç½®æµ‹è¯•ç¯å¢ƒ
**æ¸…ç†å†…å®¹**:
- ğŸ§¹ æ¸…ç†æœªå®Œæˆçš„å…¨å±€äº‹åŠ¡å’Œåˆ†æ”¯äº‹åŠ¡
- ğŸ” æ¸…ç†æ‰€æœ‰èµ„æºé”å®š
- ğŸ“ æ¸…ç†æ‰€æœ‰å›æ»šæ—¥å¿—
- ğŸ“ˆ æ˜¾ç¤ºæ¸…ç†å‰åçš„æ•°æ®ç»Ÿè®¡
- ğŸ’¡ å¯é€‰æ¸…ç†ä¸šåŠ¡æ•°æ®

**ä½¿ç”¨æ–¹æ³•**:
```bash
sqlplus test/123456@localhost:1521/ORCL @oracle-seata-cleanup.sql
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1: åˆå§‹åŒ–ç¯å¢ƒ
```bash
# æ‰§è¡Œå®Œæ•´åˆå§‹åŒ–
sqlplus test/123456@localhost:1521/ORCL @oracle-seata-complete-init.sql
```

### æ­¥éª¤2: å¯åŠ¨SeataæœåŠ¡å™¨
```bash
# ä½¿ç”¨ä¼˜åŒ–çš„å¯åŠ¨è„šæœ¬
cd C:\Users\quan\Desktop\seata\seata\bin
seata-server-optimized.bat
```

### æ­¥éª¤3: å¯åŠ¨åº”ç”¨æœåŠ¡
```bash
# å¯åŠ¨è®¢å•æœåŠ¡ï¼ˆç«¯å£8080ï¼‰
cd seata-demo/order-service
mvn spring-boot:run -Dspring-boot.run.profiles=local-oracle

# å¯åŠ¨åº“å­˜æœåŠ¡ï¼ˆç«¯å£8081ï¼‰  
cd seata-demo/stock-service
mvn spring-boot:run -Dspring-boot.run.profiles=local-oracle
```

### æ­¥éª¤4: æµ‹è¯•åˆ†å¸ƒå¼äº‹åŠ¡
```bash
# æµ‹è¯•æˆåŠŸåœºæ™¯
curl -X POST "http://localhost:8080/api/order/create?userId=user123&productId=1&quantity=2"

# æµ‹è¯•å¤±è´¥å›æ»šåœºæ™¯ï¼ˆåº“å­˜ä¸è¶³ï¼‰
curl -X POST "http://localhost:8080/api/order/create?userId=user456&productId=1&quantity=2000"
```

## ğŸ“‹ æ•°æ®åº“è¡¨ç»“æ„

### ä¸šåŠ¡è¡¨
- **orders**: è®¢å•è¡¨ - å­˜å‚¨ç”¨æˆ·è®¢å•ä¿¡æ¯
- **stock**: åº“å­˜è¡¨ - å­˜å‚¨å•†å“åº“å­˜ä¿¡æ¯

### Seataç³»ç»Ÿè¡¨
- **global_table**: å…¨å±€äº‹åŠ¡è¡¨ - è®°å½•åˆ†å¸ƒå¼äº‹åŠ¡çš„å…¨å±€ä¿¡æ¯
- **branch_table**: åˆ†æ”¯äº‹åŠ¡è¡¨ - è®°å½•åˆ†å¸ƒå¼äº‹åŠ¡çš„åˆ†æ”¯ä¿¡æ¯  
- **lock_table**: é”è¡¨ - ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„èµ„æºé”å®š
- **undo_log**: å›æ»šæ—¥å¿—è¡¨ - ATæ¨¡å¼å›æ»šæ—¶ä½¿ç”¨çš„æ•°æ®å¿«ç…§

## ğŸ”§ æ•…éšœæ’é™¤

### 1. å¦‚æœé‡åˆ°åºåˆ—ä¸å­˜åœ¨é”™è¯¯
```bash
# é‡æ–°æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
sqlplus test/123456@localhost:1521/ORCL @oracle-seata-complete-init.sql
```

### 2. å¦‚æœäº‹åŠ¡ä¸€ç›´å¡ä½
```bash
# æ‰§è¡Œæ¸…ç†è„šæœ¬
sqlplus test/123456@localhost:1521/ORCL @oracle-seata-cleanup.sql
```

### 3. å¦‚æœSeataæœåŠ¡å™¨å¯åŠ¨å¤±è´¥
```bash
# ä½¿ç”¨ä¼˜åŒ–çš„å¯åŠ¨è„šæœ¬ï¼Œå†…å­˜è®¾ç½®å·²ä¼˜åŒ–
seata-server-optimized.bat
```

## ğŸ“Š ç›‘æ§å’Œè§‚å¯Ÿ

### æŸ¥çœ‹äº‹åŠ¡çŠ¶æ€
```sql
-- æŸ¥çœ‹å…¨å±€äº‹åŠ¡
SELECT xid, status, application_id, transaction_name, gmt_create FROM global_table;

-- æŸ¥çœ‹åˆ†æ”¯äº‹åŠ¡
SELECT xid, branch_id, resource_id, status FROM branch_table;

-- æŸ¥çœ‹èµ„æºé”
SELECT xid, table_name, pk FROM lock_table;

-- æŸ¥çœ‹å›æ»šæ—¥å¿—
SELECT xid, branch_id, log_status, log_created FROM undo_log;
```

### æŸ¥çœ‹ä¸šåŠ¡æ•°æ®
```sql
-- æŸ¥çœ‹è®¢å•
SELECT id, user_id, product_id, quantity, status, create_time FROM orders;

-- æŸ¥çœ‹åº“å­˜
SELECT product_id, quantity, update_time FROM stock;
```

## âœ¨ å­¦ä¹ è¦ç‚¹

1. **ATæ¨¡å¼åŸç†**: Seataä¼šè‡ªåŠ¨è®°å½•SQLæ‰§è¡Œå‰åçš„æ•°æ®å¿«ç…§åˆ°undo_logè¡¨
2. **ä¸¤é˜¶æ®µæäº¤**: 
   - ç¬¬ä¸€é˜¶æ®µï¼šä¸šåŠ¡SQLæ‰§è¡Œ + è®°å½•undo_log
   - ç¬¬äºŒé˜¶æ®µï¼šæ ¹æ®å…¨å±€äº‹åŠ¡ç»“æœå†³å®šæäº¤æˆ–å›æ»š
3. **èµ„æºé”å®š**: lock_tableè®°å½•èµ„æºé”ï¼Œé˜²æ­¢è„å†™
4. **è‡ªåŠ¨å›æ»š**: å¤±è´¥æ—¶æ ¹æ®undo_logä¸­çš„å¿«ç…§è‡ªåŠ¨ç”Ÿæˆåå‘SQL

## ğŸ¯ æµ‹è¯•å»ºè®®

1. **æ­£å¸¸æµç¨‹æµ‹è¯•**: åº“å­˜å……è¶³çš„æƒ…å†µä¸‹åˆ›å»ºè®¢å•
2. **å›æ»šæµ‹è¯•**: åº“å­˜ä¸è¶³æ—¶è§‚å¯Ÿè‡ªåŠ¨å›æ»š
3. **å¹¶å‘æµ‹è¯•**: å¤šä¸ªè¯·æ±‚åŒæ—¶æ“ä½œç›¸åŒå•†å“
4. **å¼‚å¸¸æµ‹è¯•**: æ‰‹åŠ¨åœæ­¢æŸä¸ªæœåŠ¡è§‚å¯Ÿäº‹åŠ¡å¤„ç†

---

**æç¤º**: è¿™å¥—è„šæœ¬å·²ç»è§£å†³äº†Oracle + Seataé›†æˆçš„å¸¸è§é—®é¢˜ï¼ŒåŒ…æ‹¬åºåˆ—å‘½åã€å­—æ®µæ˜ å°„ã€ä¸»é”®çº¦æŸç­‰ï¼Œå¯ä»¥ç›´æ¥ç”¨äºå­¦ä¹ å’Œå¼€å‘ç¯å¢ƒã€‚